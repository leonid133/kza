C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MMCFLASH5
OBJECT MODULE PLACED IN mmcflash5.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.exe mmcflash5.c DB OE BR

line level    source

   1          #include "c8051f120.h"
   2          #include "mmcflash5.h"
   3          #include <init.h>
   4          
   5          xdata unsigned char flash = 0, MMC_CMD = 0xff, jump = 0, flageofrec = 0, BufferInKZA[512], BuffFromKza[512
             -];
   6          xdata unsigned long eofaddr=0x1200, address = 0x00000c00, szflash = 0, nzap = 0, lastaddr = 0, tmpaddr=0;
   7          xdata unsigned int timeFlashOver, i_wr;
   8          
   9          sbit CS = P3^2;
  10          
  11          xdata unsigned char spifcount=0;
  12          
  13          //SPI------------------------------------------------------------------
  14          void SPI_Init (void)
  15          {
  16   1              SPI0CFG = 0x40;
  17   1              SPI0CN = 0x0F;
  18   1              SPI0CKR = 0x08; //2.8 Mhz
  19   1      }                                                                                                         
             -                                                                                                                        
             -                                                                  
  20          
  21          //----------------------------------------------------------------------
  22          void SPI_isr(void) interrupt 6
  23          {
  24   1              static xdata unsigned long stoprec=0;
  25   1              static xdata unsigned char b=0xff;
  26   1              static xdata unsigned int i_CMD = 0x00;
  27   1              xdata unsigned char *pchar, dummy_CRC;
  28   1              xdata unsigned int size;
  29   1              xdata char SFRPAGE_SAVE = SFRPAGE;
  30   1              SFRPAGE = SPI0_PAGE;
  31   1      
  32   1              spifcount=0;
  33   1              
  34   1              SPIF = 0;
  35   1              flash = 0;
  36   1         if(MMC_CMD == 0xFF)
  37   1              {
  38   2                      flash=1;
  39   2                      CS = 1;
  40   2              }
  41   1              else if(MMC_CMD == 0x00) //init------------------------
  42   1              {
  43   2                      i_CMD++;
  44   2                      if(i_CMD == 1)
  45   2                      {
  46   3                              CS = 1; 
  47   3                              SPI0DAT = 0xFF; 
  48   3                      }
  49   2                      else if(i_CMD < 10)
  50   2                      {
  51   3                              SPI0DAT = 0xFF; 
  52   3                      }
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 2   

  53   2                      else if(i_CMD == 10)
  54   2                      {
  55   3                              CS = 0; 
  56   3                              SPI0DAT = 0xFF; 
  57   3                      }
  58   2                      else            //CMD0------------------------------------- 
  59   2                      {
  60   3                              MMC_CMD = 0x01;
  61   3                              i_CMD = 0x00;
  62   3                              SPI0DAT = 0x40; 
  63   3                      }
  64   2              }
  65   1              else if(MMC_CMD == 0x01)
  66   1              {
  67   2                      if (i_CMD < 0x04)
  68   2                      {
  69   3                              i_CMD++;                        
  70   3                              SPI0DAT = 0x00; 
  71   3                      }
  72   2                      else 
  73   2                      {
  74   3                              i_CMD = 0x00;
  75   3                              MMC_CMD = 0x02;
  76   3                              SPI0DAT = 0x95;
  77   3                      } 
  78   2              }
  79   1              else if(MMC_CMD == 0x02)
  80   1              {
  81   2                      MMC_CMD = 0x03;
  82   2                      SPI0DAT = 0xFF; 
  83   2              }
  84   1              else if(MMC_CMD == 0x03)
  85   1              {
  86   2                      b = SPI0DAT;
  87   2                      if(b != 0xFF);
  88   2                      {
  89   3                              MMC_CMD = 0x04;
  90   3                              timeFlashOver = 0;
  91   3                      }
  92   2                      SPI0DAT = 0xFF; 
  93   2              }
  94   1              else if(MMC_CMD == 0x04)
  95   1              {
  96   2                      b = SPI0DAT;
  97   2                      if(b == 0x00)
  98   2                      {
  99   3                              timeFlashOver = 0;
 100   3                              MMC_CMD = 0xFF;
 101   3                      }
 102   2                      else if(b == 0xFF)
 103   2                      {
 104   3                              timeFlashOver = 0;
 105   3                              MMC_CMD = 0x05;
 106   3                              CS = 1;
 107   3                      }
 108   2                      else
 109   2                      {
 110   3                              if(timeFlashOver > 10.0*FREQ)
 111   3                              {
 112   4                                      MMC_CMD = 0; SPIF = 1;
 113   4                                      goto EndSpiIsr;
 114   4                              }
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 3   

 115   3                      }
 116   2                      SPI0DAT = 0xFF; 
 117   2              } //--end CMD0--
 118   1              else if(MMC_CMD == 0x05)
 119   1              {
 120   2                      if(i_CMD < 0x09)
 121   2                      {
 122   3                              i_CMD++;
 123   3                              SPI0DAT = 0xFF; 
 124   3                      }
 125   2                      else    //CMD1
 126   2                      {
 127   3                              CS = 0; 
 128   3                              i_CMD = 0;
 129   3                              MMC_CMD = 6;
 130   3                              SPI0DAT = 0x41; 
 131   3                      }
 132   2              }
 133   1              else if(MMC_CMD == 0x06) 
 134   1              {
 135   2                      if (i_CMD < 0x04)
 136   2                      {
 137   3                              i_CMD++;
 138   3                              SPI0DAT = 0x00; 
 139   3                      }
 140   2                      else
 141   2                      {
 142   3                              i_CMD = 0x00; 
 143   3                              MMC_CMD = 0x07;
 144   3                              SPI0DAT = 0xFF;
 145   3                              timeFlashOver = 0;
 146   3                      }
 147   2              }
 148   1              else if(MMC_CMD == 0x07)
 149   1              {
 150   2                      b = SPI0DAT;
 151   2                      if(b != 0xFF)
 152   2                      {
 153   3                              timeFlashOver = 0;
 154   3                              MMC_CMD = 8;
 155   3                      }
 156   2                      else if(timeFlashOver > 10.0*FREQ)
 157   2                      {
 158   3                              MMC_CMD = 0; 
 159   3                              SPIF = 1;
 160   3                              goto EndSpiIsr;
 161   3                      }
 162   2                      SPI0DAT = 0xFF; 
 163   2              }
 164   1              else if(MMC_CMD == 0x08)
 165   1              {
 166   2                      if(SPI0DAT == 0xFF)
 167   2                      {
 168   3                              MMC_CMD = 0x09;
 169   3                      }
 170   2                      else if(timeFlashOver > 10.0*FREQ)
 171   2                      {
 172   3                              MMC_CMD = 0; 
 173   3                              SPIF = 1;
 174   3                              goto EndSpiIsr;
 175   3                      }
 176   2                      SPI0DAT = 0xFF; 
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 4   

 177   2              }
 178   1              else if(MMC_CMD == 0x09)
 179   1              {
 180   2                      if(b & 0x01)
 181   2                      {
 182   3                              MMC_CMD = 0x05;
 183   3                      }
 184   2                      else
 185   2                      {
 186   3                              CS = 1;
 187   3                              MMC_CMD = 0x0A;
 188   3                      }
 189   2                      SPI0DAT = 0xFF; 
 190   2              }
 191   1              else if(MMC_CMD == 0x0A)
 192   1              {
 193   2                      
 194   2                      CS = 1;
 195   2                      if(szflash > 0)
 196   2                      {
 197   3                              MMC_CMD = 0xFF;
 198   3                      }
 199   2                      else
 200   2                      {
 201   3                              MMC_CMD = 0x20; 
 202   3                              SPIF = 1;
 203   3                      }
 204   2              } //--end Init--
 205   1              else if(MMC_CMD == 0x10) //--write--
 206   1              {
 207   2                      CS = 0; 
 208   2                      MMC_CMD = 0x11; 
 209   2                      stoprec++;
 210   2                      if(stoprec>0xBB5D7)
 211   2                      {
 212   3                              CS = 1;
 213   3                              MMC_CMD = 0xFE;
 214   3                      }
 215   2                      SPI0DAT = 0xFF;
 216   2              }
 217   1              else if(MMC_CMD == 0x11) 
 218   1              {
 219   2                      MMC_CMD = 0x12; 
 220   2                      SPI0DAT = 0x58;
 221   2              }
 222   1              else if(MMC_CMD == 0x12) 
 223   1              {
 224   2                      MMC_CMD = 0x13;
 225   2                      SPI0DAT = ((address & 0xff000000) >> 24);
 226   2              }
 227   1              else if(MMC_CMD == 0x13) 
 228   1              {
 229   2                      MMC_CMD = 0x14;
 230   2                      SPI0DAT = ((address & 0x00ff0000) >> 16);
 231   2              }
 232   1              else if(MMC_CMD == 0x14) 
 233   1              {
 234   2                      MMC_CMD = 0x15;
 235   2                      SPI0DAT = ((address & 0x0000ff00) >> 8);
 236   2              }
 237   1              else if(MMC_CMD == 0x15) 
 238   1              {
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 5   

 239   2                      MMC_CMD = 0x16;
 240   2                      SPI0DAT = address & 0x000000ff;
 241   2              }
 242   1              else if(MMC_CMD == 0x16) 
 243   1              {
 244   2                      address += 0x200;
 245   2                      if(address > szflash) 
 246   2                              address = 0xe00; 
 247   2                      MMC_CMD = 0x17;
 248   2                      SPI0DAT = 0xFF;
 249   2              }
 250   1              else if(MMC_CMD == 0x17)
 251   1              {
 252   2                      timeFlashOver = 0;
 253   2                      MMC_CMD = 0x18;
 254   2                      SPI0DAT = 0xFF;
 255   2              }
 256   1              else if(MMC_CMD == 0x18)
 257   1              {
 258   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 40,60-Param Err
 259   2                      if(b == 0x00)
 260   2                      {
 261   3                              timeFlashOver=0;
 262   3                              MMC_CMD = 0x19;
 263   3                      }
 264   2                      else if(b == 0x20)
 265   2                      {
 266   3                              address = 0xe00;
 267   3                              MMC_CMD = 0xFF;
 268   3                      }
 269   2                      else if(b == 0x40 || b == 0x60)
 270   2                      {
 271   3                              timeFlashOver=0;
 272   3                              CS = 1;
 273   3                              flash = 3;
 274   3                              MMC_CMD = 0xFE;
 275   3                      }
 276   2                      else if(timeFlashOver > 10.0*FREQ)
 277   2                      {
 278   3                              timeFlashOver = 0;
 279   3                              CS = 1; 
 280   3                              flash = 0; 
 281   3                              MMC_CMD = 0x00;
 282   3                              address -= 0x200;
 283   3                              SPIF = 1;
 284   3                              goto EndSpiIsr;
 285   3                      }
 286   2                      SPI0DAT = 0xFF;
 287   2              }
 288   1              else if(MMC_CMD == 0x19)
 289   1              {
 290   2                      b = SPI0DAT;
 291   2                      if(b == 0xFF)
 292   2                      {
 293   3                              timeFlashOver=0;
 294   3                              MMC_CMD = 0x1A;
 295   3                      }
 296   2                      else if(timeFlashOver > 10.0*FREQ)
 297   2                      {
 298   3                              address -= 0x200;
 299   3                              CS = 1;
 300   3                              flash = 0;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 6   

 301   3                              MMC_CMD = 0x00;
 302   3                              SPIF = 1;
 303   3                              goto EndSpiIsr;
 304   3                      }
 305   2                      SPI0DAT = 0xFF;
 306   2              }
 307   1              else if(MMC_CMD == 0x1A)
 308   1              {
 309   2                      i_CMD = 0;
 310   2                      MMC_CMD = 0x1B; 
 311   2                      SPI0DAT = 0xFE;
 312   2              }
 313   1              else if(MMC_CMD == 0x1B)
 314   1              {
 315   2                      if(i_CMD >= 0x200)
 316   2                      {
 317   3                              i_CMD = 0;      
 318   3                              MMC_CMD = 0x1C; 
 319   3                              SPIF = 0; 
 320   3                              SPI0DAT = 0xFF;
 321   3                      }
 322   2                      else
 323   2                      {
 324   3                              SPI0DAT = BufferInKZA[i_CMD++];
 325   3                      }
 326   2              }
 327   1              else if(MMC_CMD == 0x1C)
 328   1              {
 329   2                      timeFlashOver=0;
 330   2                      MMC_CMD = 0x1D; 
 331   2                      SPI0DAT = 0xFF;
 332   2              }
 333   1              else if(MMC_CMD == 0x1D)
 334   1              {
 335   2                      if(SPI0DAT == 0xFF)
 336   2                      {
 337   3                              MMC_CMD = 0x1E;
 338   3                              CS = 1;
 339   3                      }
 340   2                      else if(timeFlashOver > 10.0*FREQ)
 341   2                      {
 342   3                              address -= 0x200;
 343   3                              CS = 1;
 344   3                              flash = 0;
 345   3                              MMC_CMD = 0x00;
 346   3                              SPIF = 1;
 347   3                              goto EndSpiIsr;
 348   3                      }
 349   2                      SPI0DAT = 0xFF;
 350   2              }
 351   1              else if(MMC_CMD == 0x1E)
 352   1              {
 353   2                      if(jump > 0)
 354   2                      {
 355   3                              address = lastaddr;
 356   3                              stoprec = 0;
 357   3                              jump = 0;
 358   3                      }
 359   2      
 360   2                      if(i_CMD++ < 255)
 361   2                      {
 362   3                              SPI0DAT = 0xFF;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 7   

 363   3                      }
 364   2                      else
 365   2                      {
 366   3                              MMC_CMD = 0xFF;
 367   3                              SPI0DAT = 0xFF;
 368   3                      }
 369   2                      
 370   2                      SPI0DAT = 0xFF;
 371   2              }
 372   1              else if(MMC_CMD == 0x20)        //-- CMD 9 --
 373   1              {
 374   2                      //-Ручной режим определения размера ММС-начало
 375   2                      MMC_CMD = 0xFF;
 376   2                      szflash = 0x3B600000; //950Mb
 377   2                      SPIF = 1;
 378   2                      goto EndSpiIsr;
 379   2                      //-Ручной режим определения размера ММС-конец   
 380   2                      CS = 1;
 381   2                      flash = 0; 
 382   2                      MMC_CMD = 0x21; 
 383   2                      SPI0DAT = 0xFF;
 384   2              }
 385   1              else if(MMC_CMD == 0x21)
 386   1              {
 387   2                      CS = 0; 
 388   2                      MMC_CMD = 0x22; 
 389   2                      SPI0DAT = 0xFF;
 390   2              }
 391   1              else if(MMC_CMD == 0x22)
 392   1              {
 393   2                      MMC_CMD = 0x23; 
 394   2                      SPI0DAT = (9 | 0x40);
 395   2              }
 396   1              else if(MMC_CMD == 0x23)
 397   1              {
 398   2                      MMC_CMD = 0x24; 
 399   2                      SPI0DAT = 0x00;
 400   2              }
 401   1              else if(MMC_CMD == 0x24)
 402   1              {
 403   2                      MMC_CMD = 0x25; 
 404   2                      SPI0DAT = 0x00;
 405   2              }
 406   1              else if(MMC_CMD == 0x25)
 407   1              {
 408   2                      MMC_CMD = 0x26; 
 409   2                      SPI0DAT = 0x00;
 410   2              }
 411   1              else if(MMC_CMD == 0x26)
 412   1              {
 413   2                      MMC_CMD = 0x27; 
 414   2                      SPI0DAT = 0xFF;
 415   2              }
 416   1              else if(MMC_CMD == 0x27)
 417   1              {
 418   2                      b = SPI0DAT; 
 419   2                      if(!(b & 0x80))
 420   2                      {                       
 421   3                              timeFlashOver=0;
 422   3                              MMC_CMD = 0x28;
 423   3                      }
 424   2                      SPI0DAT = 0xFF; 
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 8   

 425   2              }
 426   1              else if(MMC_CMD == 0x28)
 427   1              {
 428   2                      b = SPI0DAT;
 429   2                      if(b == 0xFE)
 430   2                      {
 431   3                              timeFlashOver=0;
 432   3                              i_CMD = 0;      
 433   3                              MMC_CMD =0x2A;  
 434   3                              SPI0DAT = 0x00; 
 435   3                              goto EndSpiIsr;
 436   3                      }
 437   2                      else if(timeFlashOver > FREQ)
 438   2                      {
 439   3                              timeFlashOver=0;
 440   3                              CS = 1; 
 441   3                              flash = 0;      
 442   3                              MMC_CMD = 0x00; 
 443   3                              SPIF = 1;
 444   3                              goto EndSpiIsr;
 445   3                      }
 446   2                      SPI0DAT = 0xFF; 
 447   2              }
 448   1              else if(MMC_CMD == 0x2A)
 449   1              {
 450   2                      *pchar++ = SPI0DAT;
 451   2                      if(i_CMD == 16)
 452   2                      {
 453   3                              i_CMD = 0;
 454   3                              MMC_CMD = 0x2B;
 455   3                              SPI0DAT = 0x00;
 456   3                      }
 457   2                      else
 458   2                      {
 459   3                              i_CMD++;
 460   3                              SPI0DAT = 0x00;
 461   3                      }
 462   2              }
 463   1              else if(MMC_CMD == 0x2B)
 464   1              {
 465   2                      dummy_CRC = SPI0DAT;  
 466   2                      MMC_CMD = 0x2C; 
 467   2                      SPI0DAT = 0x00;
 468   2              }
 469   1              else if(MMC_CMD == 0x2C)
 470   1              {
 471   2                      dummy_CRC = SPI0DAT;  
 472   2                      CS = 1; 
 473   2                      MMC_CMD = 0x2D; 
 474   2                      SPIF = 1; 
 475   2              }
 476   1              else if(MMC_CMD == 0x2D)
 477   1              {
 478   2                      MMC_CMD = 0xFF;
 479   2                      pchar += 9;
 480   2                      size = (unsigned int)((((*pchar) & 0x03) << 1) | (((*(pchar+1)) & 0x80) >> 7));
 481   2              switch(size)                        
 482   2              {                                   
 483   3              case 1: szflash = 0x800000; break;
 484   3              case 2: szflash = 0x1000000; break;
 485   3              case 3: szflash = 0x2000000; break;
 486   3              case 4: szflash = 0x4000000; break;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 9   

 487   3              case 5: szflash = 0x8000000; break;
 488   3                              case 6: szflash = 0x10000000; break;
 489   3                              case 7: szflash = 0x20000000; break;
 490   3                              case 8: szflash = 0x40000000; break; //1Gb
 491   3                              case 9: szflash = 0x80000000; break;
 492   3              default: szflash = 0xf0000000; break;
 493   3              }               
 494   2                      SPI0DAT = 0xFF;
 495   2                      flash = 1;
 496   2              }//--end CMD9--
 497   1              else if(MMC_CMD == 0x30) //Read
 498   1              {
 499   2                      flash = 4; 
 500   2                      CS = 0; 
 501   2                      MMC_CMD = 0x31;
 502   2                      SPI0DAT = 0xFF;
 503   2              }
 504   1              else if(MMC_CMD == 0x31) 
 505   1              {
 506   2                      MMC_CMD = 0x32; 
 507   2                      SPI0DAT = 0x51;
 508   2              }
 509   1              else if(MMC_CMD == 0x32) 
 510   1              {
 511   2                      MMC_CMD = 0x33; 
 512   2                      SPI0DAT = (address & 0xff000000) >> 24;
 513   2              }
 514   1              else if(MMC_CMD == 0x33) 
 515   1              {
 516   2                      MMC_CMD = 0x34; 
 517   2                      SPI0DAT = (address & 0xff0000) >> 16;
 518   2              }
 519   1              else if(MMC_CMD == 0x34) 
 520   1              {
 521   2                      MMC_CMD = 0x35; 
 522   2                      SPI0DAT = (address & 0xff00) >> 8;
 523   2              }
 524   1              else if(MMC_CMD == 0x35) 
 525   1              {
 526   2                      MMC_CMD = 0x36; 
 527   2                      SPI0DAT = (address & 0xff);
 528   2              }
 529   1              else if(MMC_CMD == 0x36) 
 530   1              {
 531   2                      timeFlashOver=0;
 532   2                      MMC_CMD = 0x37; 
 533   2                      SPI0DAT = 0xFF;
 534   2              }
 535   1              else if(MMC_CMD == 0x37) 
 536   1              {
 537   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 60-Param Err
 538   2                      if(b == 0x00)
 539   2                      {
 540   3                              MMC_CMD = 0x38;
 541   3                              timeFlashOver=0;
 542   3                      }
 543   2                      else if(b == 0x20)
 544   2                      {
 545   3                              address = 0x00000c00;
 546   3                              MMC_CMD = 0x00;
 547   3                      }
 548   2                      else if(b == 0x60)
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 10  

 549   2                      {
 550   3                              MMC_CMD = 0xFE;
 551   3                      }
 552   2                      else if(timeFlashOver > 10.0*FREQ)
 553   2                      {
 554   3                              CS = 1;
 555   3                              flash = 0;
 556   3                              SPIF = 1;
 557   3                              MMC_CMD = 0x00;
 558   3                              goto EndSpiIsr;
 559   3                      }
 560   2                      SPI0DAT = 0xFF;
 561   2              }
 562   1              else if(MMC_CMD == 0x38) 
 563   1              {
 564   2                      b = SPI0DAT;    
 565   2                      if(b == 0xFF)
 566   2                      {
 567   3                              timeFlashOver = 0;
 568   3                              MMC_CMD = 0x39;
 569   3                      }
 570   2                      else if(timeFlashOver > 10.0*FREQ)
 571   2                      {
 572   3                              CS = 1;
 573   3                              flash = 0;
 574   3                              SPIF = 1;
 575   3                              MMC_CMD = 0x00;
 576   3                              goto EndSpiIsr;
 577   3                      }
 578   2                      SPI0DAT = 0xFF;
 579   2              }
 580   1              else if(MMC_CMD == 0x39) 
 581   1              {
 582   2                      b = SPI0DAT;  // FE - DataToken, 08-Err Token Out Of Range
 583   2                      if(b != 0xFF)
 584   2                      {
 585   3                              MMC_CMD = 0x3A;
 586   3                              i_CMD = 0;
 587   3                      }
 588   2                      else if(timeFlashOver > 10.0*FREQ)
 589   2                      {
 590   3                              CS = 1;
 591   3                              flash = 0;
 592   3                              SPIF = 1;
 593   3                              MMC_CMD = 0x00;
 594   3                              goto EndSpiIsr;
 595   3                      }
 596   2                      SPI0DAT = 0xFF;
 597   2              }
 598   1              else if(MMC_CMD == 0x3A) 
 599   1              {
 600   2                      b = SPI0DAT; 
 601   2                      if(i_CMD<512)
 602   2                      {
 603   3                              BuffFromKza[i_CMD++] = b;
 604   3                              SPI0DAT = 0xFF;
 605   3                      }
 606   2                      else
 607   2                      {
 608   3                              i_CMD++;
 609   3                              SPIF = 1;
 610   3                      }
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 11  

 611   2      
 612   2                      if(i_CMD>=514)
 613   2                      {
 614   3                              i_CMD = 0;
 615   3                              timeFlashOver = 0;
 616   3                              MMC_CMD = 0x3B;
 617   3                      }
 618   2                      
 619   2              }
 620   1              else if(MMC_CMD == 0x3B)
 621   1              {
 622   2                      if(SPI0DAT == 0xFF)
 623   2                      {
 624   3                              CS = 1;
 625   3                              MMC_CMD = 0x3C;
 626   3                              flash = 5;
 627   3                              goto EndSpiIsr;
 628   3                      }
 629   2                      else if(timeFlashOver > 10.0*FREQ)
 630   2                      {
 631   3                              CS = 1;
 632   3                              flash = 0;
 633   3                              SPIF = 1;
 634   3                              MMC_CMD = 0x00;
 635   3                              goto EndSpiIsr;
 636   3                      }
 637   2                      SPI0DAT = 0xFF;
 638   2              } 
 639   1       //-end read
 640   1              else if(MMC_CMD == 0x40) //--eof--
 641   1              {
 642   2                      CS = 0; 
 643   2                      MMC_CMD = 0x41; 
 644   2                      SPI0DAT = 0xFF;
 645   2              }
 646   1              else if(MMC_CMD == 0x41) 
 647   1              {
 648   2                      MMC_CMD = 0x42; 
 649   2                      SPI0DAT = 0x58;
 650   2              }
 651   1              else if(MMC_CMD == 0x42) 
 652   1              {
 653   2                      MMC_CMD = 0x43;
 654   2                      SPI0DAT = ((eofaddr & 0xff000000) >> 24);
 655   2              }
 656   1              else if(MMC_CMD == 0x43) 
 657   1              {
 658   2                      MMC_CMD = 0x44;
 659   2                      SPI0DAT = ((eofaddr & 0x00ff0000) >> 16);
 660   2              }
 661   1              else if(MMC_CMD == 0x44) 
 662   1              {
 663   2                      MMC_CMD = 0x45;
 664   2                      SPI0DAT = ((eofaddr & 0x0000ff00) >> 8);
 665   2              }
 666   1              else if(MMC_CMD == 0x45) 
 667   1              {
 668   2                      MMC_CMD = 0x46;
 669   2                      SPI0DAT = eofaddr & 0x000000ff;
 670   2              }
 671   1              else if(MMC_CMD == 0x46) 
 672   1              {
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 12  

 673   2                      MMC_CMD = 0x47;
 674   2                      SPI0DAT = 0xFF;
 675   2              }
 676   1              else if(MMC_CMD == 0x47)
 677   1              {
 678   2                      timeFlashOver = 0;
 679   2                      MMC_CMD = 0x48;
 680   2                      SPI0DAT = 0xFF;
 681   2              }
 682   1              else if(MMC_CMD == 0x48)
 683   1              {
 684   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 40,60-Param Err
 685   2                      if(b == 0x00)
 686   2                      {
 687   3                              timeFlashOver=0;
 688   3                              MMC_CMD = 0x49;
 689   3                      }
 690   2                      else if(b == 0x20)
 691   2                      {
 692   3                              address = 0x00000e00;
 693   3                              MMC_CMD = 0xFF;
 694   3                      }
 695   2                      else if(b == 0x40 || b == 0x60)
 696   2                      {
 697   3                              timeFlashOver=0;
 698   3                              CS = 1;
 699   3                              flash = 3;
 700   3                              MMC_CMD = 0xFE;
 701   3                      }
 702   2                      else if(timeFlashOver > FREQ)
 703   2                      {
 704   3                              timeFlashOver = 0;
 705   3                              CS = 1; 
 706   3                              flash = 0; 
 707   3                              flageofrec = 1;
 708   3                              MMC_CMD = 0x00;
 709   3                              SPIF = 1;
 710   3                              goto EndSpiIsr;
 711   3                      }
 712   2                      SPI0DAT = 0xFF;
 713   2              }
 714   1              else if(MMC_CMD == 0x49)
 715   1              {
 716   2                      b = SPI0DAT;
 717   2                      if(b == 0xFF)
 718   2                      {
 719   3                              timeFlashOver=0;
 720   3                              MMC_CMD = 0x4A;
 721   3                      }
 722   2                      else if(timeFlashOver > FREQ)
 723   2                      {
 724   3                              CS = 1;
 725   3                              flash = 0;
 726   3                              flageofrec = 1;
 727   3                              MMC_CMD = 0x00;
 728   3                              SPIF = 1;
 729   3                              goto EndSpiIsr;
 730   3                      }
 731   2                      SPI0DAT = 0xFF;
 732   2              }
 733   1              else if(MMC_CMD == 0x4A)
 734   1              {
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 13  

 735   2                      i_CMD = 0;
 736   2                      MMC_CMD = 0x4B; 
 737   2                      SPI0DAT = 0xFE;
 738   2              }
 739   1              else if(MMC_CMD == 0x4B)
 740   1              {
 741   2                      if(i_CMD >= 0x200)
 742   2                      {
 743   3                              i_CMD = 0;      
 744   3                              MMC_CMD = 0x4C; 
 745   3                              SPIF = 0; 
 746   3                              SPI0DAT = 0xFF;
 747   3                      }
 748   2                      else
 749   2                      {
 750   3                              SPI0DAT = BufferInKZA[i_CMD++];
 751   3                      }
 752   2              }
 753   1              else if(MMC_CMD == 0x4C)
 754   1              {
 755   2                      timeFlashOver=0;
 756   2                      MMC_CMD = 0x4D; 
 757   2                      SPI0DAT = 0xFF;
 758   2              }
 759   1              else if(MMC_CMD == 0x4D)
 760   1              {
 761   2                      if(SPI0DAT == 0xFF)
 762   2                      {
 763   3                              i_CMD = 0;
 764   3                              MMC_CMD = 0x4E;
 765   3                              CS = 1;
 766   3                      }
 767   2                      else if(timeFlashOver > FREQ)
 768   2                      {
 769   3                              flageofrec = 1;
 770   3                              CS = 1;
 771   3                              flash = 0;
 772   3                              MMC_CMD = 0x00;
 773   3                              SPIF = 1;
 774   3                              goto EndSpiIsr;
 775   3                      }
 776   2                      SPI0DAT = 0xFF;
 777   2              }
 778   1              else if(MMC_CMD == 0x4E)
 779   1              {
 780   2                      if(i_CMD++ < 255)
 781   2                      {
 782   3                              SPI0DAT = 0xFF;
 783   3                      }
 784   2                      else
 785   2                      {
 786   3                              MMC_CMD = 0x50;
 787   3                              SPI0DAT = 0xFF;
 788   3                      }
 789   2              }
 790   1              else if(MMC_CMD == 0x50)
 791   1              {
 792   2                      flash = 4; 
 793   2                      CS = 0; 
 794   2                      MMC_CMD = 0x51;
 795   2                      SPI0DAT = 0xFF;
 796   2              }
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 14  

 797   1              else if(MMC_CMD == 0x51) 
 798   1              {
 799   2                      MMC_CMD = 0x52; 
 800   2                      SPI0DAT = 0x51;
 801   2              }
 802   1              else if(MMC_CMD == 0x52) 
 803   1              {
 804   2                      MMC_CMD = 0x53; 
 805   2                      SPI0DAT = (eofaddr & 0xff000000) >> 24;
 806   2              }
 807   1              else if(MMC_CMD == 0x53) 
 808   1              {
 809   2                      MMC_CMD = 0x54; 
 810   2                      SPI0DAT = (eofaddr & 0xff0000) >> 16;
 811   2              }
 812   1              else if(MMC_CMD == 0x54) 
 813   1              {
 814   2                      MMC_CMD = 0x55; 
 815   2                      SPI0DAT = (eofaddr & 0xff00) >> 8;
 816   2              }
 817   1              else if(MMC_CMD == 0x55) 
 818   1              {
 819   2                      MMC_CMD = 0x56; 
 820   2                      SPI0DAT = (eofaddr & 0xff);
 821   2              }
 822   1              else if(MMC_CMD == 0x56) 
 823   1              {
 824   2                      timeFlashOver=0;
 825   2                      MMC_CMD = 0x57; 
 826   2                      SPI0DAT = 0xFF;
 827   2              }
 828   1              else if(MMC_CMD == 0x57) 
 829   1              {
 830   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 60-Param Err
 831   2                      if(b == 0x00)
 832   2                      {
 833   3                              MMC_CMD = 0x58;
 834   3                              timeFlashOver=0;
 835   3                      }
 836   2                      else if(b == 0x20)
 837   2                      {
 838   3                              flageofrec = 1;
 839   3                              MMC_CMD = 0x00;
 840   3                      }
 841   2                      else if(b == 0x60)
 842   2                      {
 843   3                              MMC_CMD = 0xFE;
 844   3                      }
 845   2                      else if(timeFlashOver > FREQ)
 846   2                      {
 847   3                              flageofrec = 1;
 848   3                              CS = 1;
 849   3                              flash = 0;
 850   3                              SPIF = 1;
 851   3                              MMC_CMD = 0x00;
 852   3                              goto EndSpiIsr;
 853   3                      }
 854   2                      SPI0DAT = 0xFF;
 855   2              }
 856   1              else if(MMC_CMD == 0x58) 
 857   1              {
 858   2                      b = SPI0DAT;    
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 15  

 859   2                      if(b == 0xFF)
 860   2                      {
 861   3                              timeFlashOver = 0;
 862   3                              MMC_CMD = 0x59;
 863   3                      }
 864   2                      else if(timeFlashOver > FREQ)
 865   2                      {
 866   3                              CS = 1;
 867   3                              flash = 0;
 868   3                              SPIF = 1;
 869   3                              flageofrec = 1;
 870   3                              MMC_CMD = 0x00;
 871   3                              goto EndSpiIsr;
 872   3                      }
 873   2                      SPI0DAT = 0xFF;
 874   2              }
 875   1              else if(MMC_CMD == 0x59) 
 876   1              {
 877   2                      b = SPI0DAT;  // FE - DataToken, 08-Err Token Out Of Range
 878   2                      if(b != 0xFF)
 879   2                      {
 880   3                              MMC_CMD = 0x5A;
 881   3                              i_CMD = 0;
 882   3                      }
 883   2                      else if(timeFlashOver > FREQ)
 884   2                      {
 885   3                              CS = 1;
 886   3                              flash = 0;
 887   3                              SPIF = 1;
 888   3                              flageofrec = 1;
 889   3                              MMC_CMD = 0x00;
 890   3                              goto EndSpiIsr;
 891   3                      }
 892   2                      SPI0DAT = 0xFF;
 893   2              }
 894   1              else if(MMC_CMD == 0x5A) 
 895   1              {
 896   2                      b = SPI0DAT; 
 897   2                      if(i_CMD<512)
 898   2                      {
 899   3                              BuffFromKza[i_CMD++] = b;
 900   3                              SPI0DAT = 0xFF;
 901   3                      }
 902   2                      else
 903   2                      {
 904   3                              i_CMD++;
 905   3                              SPIF = 1;
 906   3                      }
 907   2      
 908   2                      if(i_CMD>=514)
 909   2                      {
 910   3                              i_CMD = 0;
 911   3                              timeFlashOver = 0;
 912   3                              MMC_CMD = 0x5B;
 913   3                      }
 914   2                      
 915   2              }
 916   1              else if(MMC_CMD == 0x5B)
 917   1              {
 918   2                      if(SPI0DAT == 0xFF)
 919   2                      {
 920   3                              CS = 1;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 16  

 921   3                              MMC_CMD = 0x5C;
 922   3                      }
 923   2                      else if(timeFlashOver > FREQ)
 924   2                      {
 925   3                              CS = 1;
 926   3                              flash = 0;
 927   3                              SPIF = 1;
 928   3                              flageofrec = 1;
 929   3                              MMC_CMD = 0x00;
 930   3                              goto EndSpiIsr;
 931   3                      }
 932   2                      SPI0DAT = 0xFF;
 933   2              } 
 934   1              else if(MMC_CMD == 0x5C)
 935   1              {
 936   2                      if(BuffFromKza[0]==0x65 && BuffFromKza[1]==0x6f && BuffFromKza[2] == 0x66 && BuffFromKza[3]==0x65 && Buf
             -fFromKza[4]==0x6f && BuffFromKza[5] ==0x66 && BuffFromKza[6]==0x65 && BuffFromKza[7]==0x6f && BuffFromKza[8] ==0x66)
 937   2                      {
 938   3                              flash = 1;
 939   3                              flageofrec = 0;
 940   3                              MMC_CMD = 0xFF;
 941   3                      }
 942   2                      else
 943   2                      {
 944   3                              MMC_CMD = 0x40;
 945   3                              eofaddr += 0x200;
 946   3                      }
 947   2              }
 948   1      //------------------------
 949   1              EndSpiIsr:
 950   1              SFRPAGE = SFRPAGE_SAVE;
 951   1              return;
 952   1      }
 953          
 954          //-----------------------------------------------------------------------
 955          void MMC_init1(void)
 956          {
 957   1              address = 0x00000A00;
 958   1              nzap = 0;
 959   1              szflash = 0;
 960   1              MMC_CMD = 0x00;
 961   1              SPIF = 1;
 962   1              return;
 963   1      }
 964          
 965          //-----------------------------------------------------------------------
 966          char WriteInKZA(unsigned char byte)
 967          {
 968   1              static xdata unsigned int counterBuf = 9;
 969   1              xdata unsigned char CRC;
 970   1              xdata unsigned long tmpNzap;
 971   1              static xdata unsigned long eof = 0;
 972   1              
 973   1              
 974   1              if(MMC_CMD == 0xFF)
 975   1              {
 976   2                      flash = 1;
 977   2              }
 978   1      
 979   1              if(MMC_CMD == 0xFE)
 980   1              {
 981   2                      return 0;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 17  

 982   2              }
 983   1      
 984   1              if((flageofrec == 1)&&(flash == 1))
 985   1              {
 986   2                      flash = 0;
 987   2                      MMC_CMD = 0x40;
 988   2              }       
 989   1              if(MMC_CMD == 0x40)
 990   1              {
 991   2                      SPIF = 1;
 992   2              }
 993   1              if((flash == 1)&&(nzap == 0)&&(szflash > 0))
 994   1              {
 995   2                      address = 0x00000c00;
 996   2                      flash = 4;
 997   2                      MMC_CMD = 0x30;
 998   2                      SPIF = 1;
 999   2              }
1000   1              else if((flash == 5)&&(nzap == 1))
1001   1              {
1002   2                      eofaddr = 0x1000;
1003   2                      address = 0xc00;
1004   2                      lastaddr = 0xe00;
1005   2                      jump = 1;
1006   2                      nzap++;
1007   2                      for(i_wr = 0; i_wr < 512; i_wr++)
1008   2                      {
1009   3                              BufferInKZA[i_wr++]=0x00;
1010   3                      }
1011   2                      BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1012   2                      BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1013   2                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1014   2                      BufferInKZA[3] =  nzap & 0x000000ff;  
1015   2                      BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1016   2                      BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1017   2                      BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1018   2                      BufferInKZA[7] =  lastaddr & 0x000000ff;  
1019   2                      CRC = BufferInKZA[0];           
1020   2                      for(i_wr = 1; i_wr < 8; i_wr++)
1021   2                      {
1022   3                                      CRC = CRC^BufferInKZA[i_wr];
1023   3                      }
1024   2                      BufferInKZA[8]  = CRC;
1025   2                      MMC_CMD = 0x10;
1026   2                      SPIF = 1;       
1027   2              }
1028   1              else if((flash == 5)&&(nzap > 1))
1029   1              {
1030   2                      tmpNzap = BuffFromKza[0];
1031   2                      for(i_wr = 1; i_wr < 4; i_wr++)
1032   2                      {
1033   3                              tmpNzap = (tmpNzap<<8)+BuffFromKza[i_wr];
1034   3                      }
1035   2                                      
1036   2                      if(nzap != tmpNzap)
1037   2                      {
1038   3                              if(BuffFromKza[0]==0x65 && BuffFromKza[1]==0x6f && BuffFromKza[2] == 0x66 && BuffFromKza[3]==0x65 && Bu
             -ffFromKza[4]==0x6f && BuffFromKza[5] ==0x66 && BuffFromKza[6]==0x65 && BuffFromKza[7]==0x6f && BuffFromKza[8] ==0x66)
1039   3                              {
1040   4                                              lastaddr = address;
1041   4                                              address = 0xc00;
1042   4                                              jump = 1;
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 18  

1043   4                                              nzap++;
1044   4                                              for(i_wr = 0; i_wr < 512; i_wr++)
1045   4                                              {
1046   5                                                      BufferInKZA[i_wr++]=0x00;
1047   5                                              }
1048   4                                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1049   4                                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1050   4                                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1051   4                                              BufferInKZA[3] =  nzap & 0x000000ff;  
1052   4                                              BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1053   4                                              BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1054   4                                              BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1055   4                                              BufferInKZA[7] =  lastaddr & 0x000000ff;  
1056   4                                              CRC = BufferInKZA[0];           
1057   4                                              for(i_wr = 1; i_wr < 8; i_wr++)
1058   4                                              {
1059   5                                                      CRC = CRC^BufferInKZA[i_wr];
1060   5                                              }
1061   4                                              BufferInKZA[8]  = CRC;
1062   4                                              MMC_CMD = 0x10;
1063   4                                              SPIF = 1;
1064   4                              }
1065   3                              else
1066   3                              {
1067   4                                      address += 0x200;       
1068   4                                      if(address > szflash) 
1069   4                                              address = 0x1000;
1070   4                                      
1071   4                                      eof++;
1072   4                                      if(eof>0x3e8)   
1073   4                                      {
1074   5                                              lastaddr = eofaddr;
1075   5                                              address = 0x00000c00;
1076   5                                              jump = 1;
1077   5                                              nzap++;
1078   5                                              for(i_wr = 0; i_wr < 512; i_wr++)
1079   5                                              {
1080   6                                                      BufferInKZA[i_wr++]=0x00;
1081   6                                              }
1082   5                                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1083   5                                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1084   5                                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1085   5                                              BufferInKZA[3] =  nzap & 0x000000ff;  
1086   5                                              BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1087   5                                              BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1088   5                                              BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1089   5                                              BufferInKZA[7] =  lastaddr & 0x000000ff;  
1090   5                                              CRC = BufferInKZA[0];           
1091   5                                              for(i_wr = 1; i_wr < 8; i_wr++)
1092   5                                              {
1093   6                                                      CRC = CRC^BufferInKZA[i_wr];
1094   6                                              }
1095   5                                              BufferInKZA[8]  = CRC;
1096   5                                              MMC_CMD = 0x10;
1097   5                                              SPIF = 1;
1098   5                                      }
1099   4                                      else
1100   4                                      {
1101   5                                              flash = 4;
1102   5                                              MMC_CMD = 0x30;
1103   5                                              SPIF = 1;
1104   5                                      }
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 19  

1105   4                              }
1106   3                      }
1107   2                      else  //читать дальше
1108   2                      {
1109   3                              CRC = BuffFromKza[0];
1110   3                              for(i_wr = 1; i_wr < 9; i_wr++)
1111   3                              {
1112   4                                      CRC = CRC^BuffFromKza[i_wr];;
1113   4                              }
1114   3                              if(!CRC) 
1115   3                              {
1116   4                                      address = BuffFromKza[4];
1117   4                                      address = (address<<8)+BuffFromKza[5];
1118   4                                      address = (address<<8)+BuffFromKza[6];
1119   4                                      address = (address<<8)+BuffFromKza[7];
1120   4                              }
1121   3                              else
1122   3                              {
1123   4                                      address += 0x200;       
1124   4                              }
1125   3                              flash = 4;
1126   3                              MMC_CMD = 0x30;
1127   3                              SPIF = 1;
1128   3                      }
1129   2              }
1130   1              else if((flash == 5)&&(nzap == 0))
1131   1              {
1132   2                      CRC = BuffFromKza[0];
1133   2                      for(i_wr = 1; i_wr < 9; i_wr++)
1134   2                      {
1135   3                              CRC = CRC^BuffFromKza[i_wr];;
1136   3                      }
1137   2                      if(!CRC && (BuffFromKza[0]!=0 || BuffFromKza[1]!=0 || BuffFromKza[2]!=0 || BuffFromKza[3]!=0 || BuffFrom
             -Kza[4]!=0 || BuffFromKza[5]!=0 || BuffFromKza[6]!=0 || BuffFromKza[7]!=0 || BuffFromKza[8]!=0)) 
1138   2                      {
1139   3                                      nzap = BuffFromKza[0];
1140   3                                      for(i_wr = 1; i_wr < 4; i_wr++)
1141   3                                      {
1142   4                                              nzap = (nzap<<8)+BuffFromKza[i_wr];
1143   4                                      }
1144   3                                      lastaddr = BuffFromKza[4];
1145   3                                      for(i_wr = 5; i_wr < 8; i_wr++)
1146   3                                      {
1147   4                                              lastaddr = (lastaddr<<8)+BuffFromKza[i_wr];
1148   4                                      }
1149   3                                      
1150   3                                      address = lastaddr;
1151   3                      }
1152   2                      else
1153   2                      {
1154   3                                      nzap = 1;
1155   3                                      address = 0xe00;
1156   3                                      lastaddr = address;
1157   3                      }
1158   2                      flash = 4;
1159   2                      MMC_CMD = 0x30;
1160   2                      SPIF = 1;
1161   2              }
1162   1      
1163   1              if((flash == 1)&&(counterBuf < 512))
1164   1              {
1165   2                      BufferInKZA[counterBuf++] = byte;       
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 20  

1166   2                      return 1;
1167   2              }
1168   1              else if((counterBuf >= 512)&&(szflash > 0)&&(flash == 1))
1169   1              {
1170   2                      if((eofaddr-address) == 0x00 || (eofaddr-address) > szflash)
1171   2                      {
1172   3                              flageofrec = 1;
1173   3                              eofaddr = address + 0x7d000;
1174   3                              if(eofaddr > szflash) 
1175   3                                      eofaddr = 0x1200; 
1176   3                              
1177   3                              for(i_wr = 0; i_wr < 9; i_wr++)
1178   3                              {
1179   4                                      BufferInKZA[i_wr++]=0x65;
1180   4                                      BufferInKZA[i_wr++]=0x6f;
1181   4                                      BufferInKZA[i_wr]=0x66;
1182   4                              }
1183   3                              MMC_CMD = 0x40;
1184   3                      }
1185   2                      else
1186   2                      {
1187   3                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1188   3                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1189   3                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1190   3                              BufferInKZA[3] =  nzap & 0x000000ff;  
1191   3                              BufferInKZA[4] = (eofaddr & 0xff000000) >> 24;
1192   3                              BufferInKZA[5] = (eofaddr & 0x00ff0000) >> 16;
1193   3                              BufferInKZA[6] = (eofaddr & 0x0000ff00) >> 8;
1194   3                              BufferInKZA[7] =  eofaddr & 0x000000ff;  
1195   3                              CRC = BufferInKZA[0];           
1196   3                              for(i_wr = 1; i_wr < 8; i_wr++)
1197   3                              {
1198   4                                      CRC = CRC^BufferInKZA[i_wr];
1199   4                              }
1200   3                              BufferInKZA[8]  = CRC;
1201   3                              counterBuf = 9;
1202   3                              MMC_CMD = 0x10;
1203   3                              SPIF = 1;
1204   3                      }
1205   2              }
1206   1              else if((flash == 1)&&(szflash == 0))
1207   1              {
1208   2                      MMC_CMD = 0x20;
1209   2                      SPIF = 1;
1210   2              }
1211   1              
1212   1              if(spifcount>200)
1213   1              {
1214   2                      spifcount=0;
1215   2                      SPIF=1;
1216   2              }
1217   1              else
1218   1              {
1219   2                      spifcount++;
1220   2              }
1221   1      
1222   1              return 0;
1223   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6951    ----
C51 COMPILER V9.00   MMCFLASH5                                                             10/09/2012 11:13:55 PAGE 21  

   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   1070      12
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
