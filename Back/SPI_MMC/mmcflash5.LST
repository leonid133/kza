C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MMCFLASH5
OBJECT MODULE PLACED IN mmcflash5.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.exe mmcflash5.c DB OE BR

line level    source

   1          #include "c8051f120.h"
   2          #include "mmcflash5.h"
   3          #include <intrins.h>
   4          #include <stdio.h>                     
   5          #include <ctype.h> 
   6          
   7          xdata unsigned char flash = 0, MMC_CMD = 0xff, jump = 0, flageofrec = 0;
   8          xdata unsigned long eofaddr=0x1200, address = 0x00000c00, szflash = 0, nzap = 0, lastaddr = 0, tmpaddr=0;
   9          
  10          xdata unsigned int i_wr;
  11          xdata unsigned char BufferInKZA[512], BuffOutKza[512];
  12          sbit CS = P3^2;
  13          
  14          //SPI------------------------------------------------------------------
  15          void SPI_Init (void)
  16          {
  17   1              SPI0CFG = 0x40;
  18   1              SPI0CN = 0x0F;
  19   1              SPI0CKR = 0x08; //2.8 Mhz
  20   1      }                                                                                                         
             -                                                                                                                        
             -                                                                  
  21          
  22          //----------------------------------------------------------------------
  23          void SPI_isr(void) interrupt 6
  24          {
  25   1              static xdata unsigned long stoprec=0;
  26   1              static xdata unsigned char b=0xff;
  27   1              static xdata unsigned int i_CMD = 0x00;
  28   1              static xdata unsigned long timeFlashOver = 0;
  29   1              xdata unsigned char *pchar, dummy_CRC;
  30   1              xdata unsigned int size;
  31   1              xdata char SFRPAGE_SAVE = SFRPAGE;
  32   1              SFRPAGE = SPI0_PAGE;
  33   1      
  34   1              SPIF = 0;
  35   1              flash = 0;
  36   1         if(MMC_CMD == 0xFF)
  37   1              {
  38   2                      flash=1;
  39   2                      CS = 1;
  40   2              }
  41   1              else if(MMC_CMD == 0x00) //init------------------------
  42   1              {
  43   2                      i_CMD++;
  44   2                      if(i_CMD == 1)
  45   2                      {
  46   3                              CS = 1; 
  47   3                              SPI0DAT = 0xFF; 
  48   3                      }
  49   2                      else if(i_CMD < 10)
  50   2                      {
  51   3                              SPI0DAT = 0xFF; 
  52   3                      }
  53   2                      else if(i_CMD == 10)
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 2   

  54   2                      {
  55   3                              CS = 0; 
  56   3                              SPI0DAT = 0xFF; 
  57   3                      }
  58   2                      else            //CMD0------------------------------------- 
  59   2                      {
  60   3                              MMC_CMD = 0x01;
  61   3                              i_CMD = 0x00;
  62   3                              SPI0DAT = 0x40; 
  63   3                      }
  64   2              }
  65   1              else if(MMC_CMD == 0x01)
  66   1              {
  67   2                      if (i_CMD < 0x04)
  68   2                      {
  69   3                              i_CMD++;                        
  70   3                              SPI0DAT = 0x00; 
  71   3                      }
  72   2                      else 
  73   2                      {
  74   3                              i_CMD = 0x00;
  75   3                              MMC_CMD = 0x02;
  76   3                              SPI0DAT = 0x95;
  77   3                      } 
  78   2              }
  79   1              else if(MMC_CMD == 0x02)
  80   1              {
  81   2                      MMC_CMD = 0x03;
  82   2                      SPI0DAT = 0xFF; 
  83   2              }
  84   1              else if(MMC_CMD == 0x03)
  85   1              {
  86   2                      b = SPI0DAT;
  87   2                      if(b != 0xFF);
  88   2                      {
  89   3                              MMC_CMD = 0x04;
  90   3                              timeFlashOver = 0;
  91   3                      }
  92   2                      SPI0DAT = 0xFF; 
  93   2              }
  94   1              else if(MMC_CMD == 0x04)
  95   1              {
  96   2                      b = SPI0DAT;
  97   2                      if(b == 0x00)
  98   2                      {
  99   3                              timeFlashOver = 0;
 100   3                              MMC_CMD = 0xFF;
 101   3                      }
 102   2                      else if(b == 0xFF)
 103   2                      {
 104   3                              timeFlashOver = 0;
 105   3                              MMC_CMD = 0x05;
 106   3                              CS = 1;
 107   3                      }
 108   2                      else
 109   2                      {
 110   3                              if(timeFlashOver++ > 0x001d0000)
 111   3                              {
 112   4                                      MMC_CMD = 0; SPIF = 1;
 113   4                                      goto EndSpiIsr;
 114   4                              }
 115   3                      }
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 3   

 116   2                      SPI0DAT = 0xFF; 
 117   2              } //--end CMD0--
 118   1              else if(MMC_CMD == 0x05)
 119   1              {
 120   2                      if(i_CMD < 0x09)
 121   2                      {
 122   3                              i_CMD++;
 123   3                              SPI0DAT = 0xFF; 
 124   3                      }
 125   2                      else    //CMD1
 126   2                      {
 127   3                              CS = 0; 
 128   3                              i_CMD = 0;
 129   3                              MMC_CMD = 6;
 130   3                              SPI0DAT = 0x41; 
 131   3                      }
 132   2              }
 133   1              else if(MMC_CMD == 0x06) 
 134   1              {
 135   2                      if (i_CMD < 0x04)
 136   2                      {
 137   3                              i_CMD++;
 138   3                              SPI0DAT = 0x00; 
 139   3                      }
 140   2                      else
 141   2                      {
 142   3                              i_CMD = 0x00; 
 143   3                              MMC_CMD = 0x07;
 144   3                              SPI0DAT = 0xFF;
 145   3                              timeFlashOver = 0;
 146   3                      }
 147   2              }
 148   1              else if(MMC_CMD == 0x07)
 149   1              {
 150   2                      b = SPI0DAT;
 151   2                      if(b != 0xFF)
 152   2                      {
 153   3                              timeFlashOver = 0;
 154   3                              MMC_CMD = 8;
 155   3                      }
 156   2                      else if(timeFlashOver++ > 0x001d0000)
 157   2                      {
 158   3                              MMC_CMD = 0; 
 159   3                              SPIF = 1;
 160   3                              goto EndSpiIsr;
 161   3                      }
 162   2                      SPI0DAT = 0xFF; 
 163   2              }
 164   1              else if(MMC_CMD == 0x08)
 165   1              {
 166   2                      if(SPI0DAT == 0xFF)
 167   2                      {
 168   3                              MMC_CMD = 0x09;
 169   3                      }
 170   2                      SPI0DAT = 0xFF; 
 171   2              }
 172   1              else if(MMC_CMD == 0x09)
 173   1              {
 174   2                      if(b & 0x01)
 175   2                      {
 176   3                              MMC_CMD = 0x05;
 177   3                      }
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 4   

 178   2                      else
 179   2                      {
 180   3                              CS = 1;
 181   3                              MMC_CMD = 0x0A;
 182   3                      }
 183   2                      SPI0DAT = 0xFF; 
 184   2              }
 185   1              else if(MMC_CMD == 0x0A)
 186   1              {
 187   2                      
 188   2                      CS = 1;
 189   2                      if(szflash > 0)
 190   2                      {
 191   3                              MMC_CMD = 0xFF;
 192   3                      }
 193   2                      else
 194   2                      {
 195   3                              MMC_CMD = 0x20; 
 196   3                              SPIF = 1;
 197   3                      }
 198   2              } //--end Init--
 199   1              else if(MMC_CMD == 0x10) //--write--
 200   1              {
 201   2                      CS = 0; 
 202   2                      MMC_CMD = 0x11; 
 203   2                      stoprec++;
 204   2                      if(stoprec>0xBB5D7)
 205   2                      {
 206   3                              CS = 1;
 207   3                              MMC_CMD = 0xFE;
 208   3                      }
 209   2                      SPI0DAT = 0xFF;
 210   2              }
 211   1              else if(MMC_CMD == 0x11) 
 212   1              {
 213   2                      MMC_CMD = 0x12; 
 214   2                      SPI0DAT = 0x58;
 215   2              }
 216   1              else if(MMC_CMD == 0x12) 
 217   1              {
 218   2                      MMC_CMD = 0x13;
 219   2                      SPI0DAT = ((address & 0xff000000) >> 24);
 220   2              }
 221   1              else if(MMC_CMD == 0x13) 
 222   1              {
 223   2                      MMC_CMD = 0x14;
 224   2                      SPI0DAT = ((address & 0x00ff0000) >> 16);
 225   2              }
 226   1              else if(MMC_CMD == 0x14) 
 227   1              {
 228   2                      MMC_CMD = 0x15;
 229   2                      SPI0DAT = ((address & 0x0000ff00) >> 8);
 230   2              }
 231   1              else if(MMC_CMD == 0x15) 
 232   1              {
 233   2                      MMC_CMD = 0x16;
 234   2                      SPI0DAT = address & 0x000000ff;
 235   2              }
 236   1              else if(MMC_CMD == 0x16) 
 237   1              {
 238   2                      address += 0x200;
 239   2                      if(address > szflash) 
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 5   

 240   2                              address = 0xe00; 
 241   2                      MMC_CMD = 0x17;
 242   2                      SPI0DAT = 0xFF;
 243   2              }
 244   1              else if(MMC_CMD == 0x17)
 245   1              {
 246   2                      timeFlashOver = 0;
 247   2                      MMC_CMD = 0x18;
 248   2                      SPI0DAT = 0xFF;
 249   2              }
 250   1              else if(MMC_CMD == 0x18)
 251   1              {
 252   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 40,60-Param Err
 253   2                      if(b == 0x00)
 254   2                      {
 255   3                              timeFlashOver=0;
 256   3                              MMC_CMD = 0x19;
 257   3                      }
 258   2                      else if(b == 0x20)
 259   2                      {
 260   3                              address = 0xe00;
 261   3                              MMC_CMD = 0xFF;
 262   3                      }
 263   2                      else if(b == 0x40 || b == 0x60)
 264   2                      {
 265   3                              timeFlashOver=0;
 266   3                              CS = 1;
 267   3                              flash = 3;
 268   3                              MMC_CMD = 0xFE;
 269   3                      }
 270   2                      else if(timeFlashOver++ > 0x001d0000)
 271   2                      {
 272   3                              timeFlashOver = 0;
 273   3                              CS = 1; 
 274   3                              flash = 0; 
 275   3                              MMC_CMD = 0x00;
 276   3                              address -= 0x200;
 277   3                              SPIF = 1;
 278   3                              goto EndSpiIsr;
 279   3                      }
 280   2                      SPI0DAT = 0xFF;
 281   2              }
 282   1              else if(MMC_CMD == 0x19)
 283   1              {
 284   2                      b = SPI0DAT;
 285   2                      if(b == 0xFF)
 286   2                      {
 287   3                              timeFlashOver=0;
 288   3                              MMC_CMD = 0x1A;
 289   3                      }
 290   2                      else if(timeFlashOver++ > 0x001d0000)
 291   2                      {
 292   3                              address -= 0x200;
 293   3                              CS = 1;
 294   3                              flash = 0;
 295   3                              MMC_CMD = 0x00;
 296   3                              SPIF = 1;
 297   3                              goto EndSpiIsr;
 298   3                      }
 299   2                      SPI0DAT = 0xFF;
 300   2              }
 301   1              else if(MMC_CMD == 0x1A)
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 6   

 302   1              {
 303   2                      i_CMD = 0;
 304   2                      MMC_CMD = 0x1B; 
 305   2                      SPI0DAT = 0xFE;
 306   2              }
 307   1              else if(MMC_CMD == 0x1B)
 308   1              {
 309   2                      if(i_CMD >= 0x200)
 310   2                      {
 311   3                              i_CMD = 0;      
 312   3                              MMC_CMD = 0x1C; 
 313   3                              SPIF = 0; 
 314   3                              SPI0DAT = 0xFF;
 315   3                      }
 316   2                      else
 317   2                      {
 318   3                              SPI0DAT = BufferInKZA[i_CMD++];
 319   3                      }
 320   2              }
 321   1              else if(MMC_CMD == 0x1C)
 322   1              {
 323   2                      timeFlashOver=0;
 324   2                      MMC_CMD = 0x1D; 
 325   2                      SPI0DAT = 0xFF;
 326   2              }
 327   1              else if(MMC_CMD == 0x1D)
 328   1              {
 329   2                      if(SPI0DAT == 0xFF)
 330   2                      {
 331   3                              MMC_CMD = 0x1E;
 332   3                              CS = 1;
 333   3                      }
 334   2                      else if(timeFlashOver++ > 0x001d0000)
 335   2                      {
 336   3                              address -= 0x200;
 337   3                              CS = 1;
 338   3                              flash = 0;
 339   3                              MMC_CMD = 0x00;
 340   3                              SPIF = 1;
 341   3                              goto EndSpiIsr;
 342   3                      }
 343   2                      SPI0DAT = 0xFF;
 344   2              }
 345   1              else if(MMC_CMD == 0x1E)
 346   1              {
 347   2                      if(jump > 0)
 348   2                      {
 349   3                              address = lastaddr;
 350   3                              stoprec = 0;
 351   3                              jump = 0;
 352   3                      }
 353   2      
 354   2                      if(i_CMD++ < 255)
 355   2                      {
 356   3                              SPI0DAT = 0xFF;
 357   3                      }
 358   2                      else
 359   2                      {
 360   3                              MMC_CMD = 0xFF;
 361   3                              SPI0DAT = 0xFF;
 362   3                      }
 363   2                      
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 7   

 364   2                      SPI0DAT = 0xFF;
 365   2              }
 366   1              else if(MMC_CMD == 0x20)        //-- CMD 9 --
 367   1              {
 368   2                      //-Ручной режим определения размера ММС-начало
 369   2                      MMC_CMD = 0xFF;
 370   2                      szflash = 0x3B600000; //950Mb
 371   2                      SPIF = 1;
 372   2                      goto EndSpiIsr;
 373   2                      //-Ручной режим определения размера ММС-конец   
 374   2                      CS = 1;
 375   2                      flash = 0; 
 376   2                      MMC_CMD = 0x21; 
 377   2                      SPI0DAT = 0xFF;
 378   2              }
 379   1              else if(MMC_CMD == 0x21)
 380   1              {
 381   2                      CS = 0; 
 382   2                      MMC_CMD = 0x22; 
 383   2                      SPI0DAT = 0xFF;
 384   2              }
 385   1              else if(MMC_CMD == 0x22)
 386   1              {
 387   2                      MMC_CMD = 0x23; 
 388   2                      SPI0DAT = (9 | 0x40);
 389   2              }
 390   1              else if(MMC_CMD == 0x23)
 391   1              {
 392   2                      MMC_CMD = 0x24; 
 393   2                      SPI0DAT = 0x00;
 394   2              }
 395   1              else if(MMC_CMD == 0x24)
 396   1              {
 397   2                      MMC_CMD = 0x25; 
 398   2                      SPI0DAT = 0x00;
 399   2              }
 400   1              else if(MMC_CMD == 0x25)
 401   1              {
 402   2                      MMC_CMD = 0x26; 
 403   2                      SPI0DAT = 0x00;
 404   2              }
 405   1              else if(MMC_CMD == 0x26)
 406   1              {
 407   2                      MMC_CMD = 0x27; 
 408   2                      SPI0DAT = 0xFF;
 409   2              }
 410   1              else if(MMC_CMD == 0x27)
 411   1              {
 412   2                      b = SPI0DAT; 
 413   2                      if(!(b & 0x80))
 414   2                      {                       
 415   3                              timeFlashOver=0;
 416   3                              MMC_CMD = 0x28;
 417   3                      }
 418   2                      SPI0DAT = 0xFF; 
 419   2              }
 420   1              else if(MMC_CMD == 0x28)
 421   1              {
 422   2                      b = SPI0DAT;
 423   2                      if(b == 0xFE)
 424   2                      {
 425   3                              timeFlashOver=0;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 8   

 426   3                              i_CMD = 0;      
 427   3                              MMC_CMD =0x2A;  
 428   3                              SPI0DAT = 0x00; 
 429   3                              goto EndSpiIsr;
 430   3                      }
 431   2                      else if(timeFlashOver++ > 0x0001f000)
 432   2                      {
 433   3                              timeFlashOver=0;
 434   3                              CS = 1; 
 435   3                              flash = 0;      
 436   3                              MMC_CMD = 0x00; 
 437   3                              SPIF = 1;
 438   3                              goto EndSpiIsr;
 439   3                      }
 440   2                      SPI0DAT = 0xFF; 
 441   2              }
 442   1              else if(MMC_CMD == 0x2A)
 443   1              {
 444   2                      *pchar++ = SPI0DAT;
 445   2                      if(i_CMD == 16)
 446   2                      {
 447   3                              i_CMD = 0;
 448   3                              MMC_CMD = 0x2B;
 449   3                              SPI0DAT = 0x00;
 450   3                      }
 451   2                      else
 452   2                      {
 453   3                              i_CMD++;
 454   3                              SPI0DAT = 0x00;
 455   3                      }
 456   2              }
 457   1              else if(MMC_CMD == 0x2B)
 458   1              {
 459   2                      dummy_CRC = SPI0DAT;  
 460   2                      MMC_CMD = 0x2C; 
 461   2                      SPI0DAT = 0x00;
 462   2              }
 463   1              else if(MMC_CMD == 0x2C)
 464   1              {
 465   2                      dummy_CRC = SPI0DAT;  
 466   2                      CS = 1; 
 467   2                      MMC_CMD = 0x2D; 
 468   2                      SPIF = 1; 
 469   2              }
 470   1              else if(MMC_CMD == 0x2D)
 471   1              {
 472   2                      MMC_CMD = 0xFF;
 473   2                      pchar += 9;
 474   2                      size = (unsigned int)((((*pchar) & 0x03) << 1) | (((*(pchar+1)) & 0x80) >> 7));
 475   2              switch(size)                        
 476   2              {                                   
 477   3              case 1: szflash = 0x800000; break;
 478   3              case 2: szflash = 0x1000000; break;
 479   3              case 3: szflash = 0x2000000; break;
 480   3              case 4: szflash = 0x4000000; break;
 481   3              case 5: szflash = 0x8000000; break;
 482   3                              case 6: szflash = 0x10000000; break;
 483   3                              case 7: szflash = 0x20000000; break;
 484   3                              case 8: szflash = 0x40000000; break; //1Gb
 485   3                              case 9: szflash = 0x80000000; break;
 486   3              default: szflash = 0xf0000000; break;
 487   3              }               
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 9   

 488   2                      SPI0DAT = 0xFF;
 489   2                      flash = 1;
 490   2              }//--end CMD9--
 491   1              else if(MMC_CMD == 0x30) //Read
 492   1              {
 493   2                      flash = 4; 
 494   2                      CS = 0; 
 495   2                      MMC_CMD = 0x31;
 496   2                      SPI0DAT = 0xFF;
 497   2              }
 498   1              else if(MMC_CMD == 0x31) 
 499   1              {
 500   2                      MMC_CMD = 0x32; 
 501   2                      SPI0DAT = 0x51;
 502   2              }
 503   1              else if(MMC_CMD == 0x32) 
 504   1              {
 505   2                      MMC_CMD = 0x33; 
 506   2                      SPI0DAT = (address & 0xff000000) >> 24;
 507   2              }
 508   1              else if(MMC_CMD == 0x33) 
 509   1              {
 510   2                      MMC_CMD = 0x34; 
 511   2                      SPI0DAT = (address & 0xff0000) >> 16;
 512   2              }
 513   1              else if(MMC_CMD == 0x34) 
 514   1              {
 515   2                      MMC_CMD = 0x35; 
 516   2                      SPI0DAT = (address & 0xff00) >> 8;
 517   2              }
 518   1              else if(MMC_CMD == 0x35) 
 519   1              {
 520   2                      MMC_CMD = 0x36; 
 521   2                      SPI0DAT = (address & 0xff);
 522   2              }
 523   1              else if(MMC_CMD == 0x36) 
 524   1              {
 525   2                      timeFlashOver=0;
 526   2                      MMC_CMD = 0x37; 
 527   2                      SPI0DAT = 0xFF;
 528   2              }
 529   1              else if(MMC_CMD == 0x37) 
 530   1              {
 531   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 60-Param Err
 532   2                      if(b == 0x00)
 533   2                      {
 534   3                              MMC_CMD = 0x38;
 535   3                              timeFlashOver=0;
 536   3                      }
 537   2                      else if(b == 0x20)
 538   2                      {
 539   3                              address = 0x00000c00;
 540   3                              MMC_CMD = 0x00;
 541   3                      }
 542   2                      else if(b == 0x60)
 543   2                      {
 544   3                              MMC_CMD = 0xFE;
 545   3                      }
 546   2                      else if(timeFlashOver++ > 0x001d0000)
 547   2                      {
 548   3                              CS = 1;
 549   3                              flash = 0;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 10  

 550   3                              SPIF = 1;
 551   3                              MMC_CMD = 0x00;
 552   3                              goto EndSpiIsr;
 553   3                      }
 554   2                      SPI0DAT = 0xFF;
 555   2              }
 556   1              else if(MMC_CMD == 0x38) 
 557   1              {
 558   2                      b = SPI0DAT;    
 559   2                      if(b == 0xFF)
 560   2                      {
 561   3                              timeFlashOver = 0;
 562   3                              MMC_CMD = 0x39;
 563   3                      }
 564   2                      else if(timeFlashOver++ > 0x001d0000)
 565   2                      {
 566   3                              CS = 1;
 567   3                              flash = 0;
 568   3                              SPIF = 1;
 569   3                              MMC_CMD = 0x00;
 570   3                              goto EndSpiIsr;
 571   3                      }
 572   2                      SPI0DAT = 0xFF;
 573   2              }
 574   1              else if(MMC_CMD == 0x39) 
 575   1              {
 576   2                      b = SPI0DAT;  // FE - DataToken, 08-Err Token Out Of Range
 577   2                      if(b != 0xFF)
 578   2                      {
 579   3                              MMC_CMD = 0x3A;
 580   3                              i_CMD = 0;
 581   3                      }
 582   2                      else if(timeFlashOver++ > 0x001d0000)
 583   2                      {
 584   3                              CS = 1;
 585   3                              flash = 0;
 586   3                              SPIF = 1;
 587   3                              MMC_CMD = 0x00;
 588   3                              goto EndSpiIsr;
 589   3                      }
 590   2                      SPI0DAT = 0xFF;
 591   2              }
 592   1              else if(MMC_CMD == 0x3A) 
 593   1              {
 594   2                      b = SPI0DAT; 
 595   2                      if(i_CMD<512)
 596   2                      {
 597   3                              BuffOutKza[i_CMD++] = b;
 598   3                              SPI0DAT = 0xFF;
 599   3                      }
 600   2                      else
 601   2                      {
 602   3                              i_CMD++;
 603   3                              SPIF = 1;
 604   3                      }
 605   2      
 606   2                      if(i_CMD>=514)
 607   2                      {
 608   3                              i_CMD = 0;
 609   3                              timeFlashOver = 0;
 610   3                              MMC_CMD = 0x3B;
 611   3                      }
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 11  

 612   2                      
 613   2              }
 614   1              else if(MMC_CMD == 0x3B)
 615   1              {
 616   2                      if(SPI0DAT == 0xFF)
 617   2                      {
 618   3                              CS = 1;
 619   3                              MMC_CMD = 0x3C;
 620   3                              flash = 5;
 621   3                              goto EndSpiIsr;
 622   3                      }
 623   2                      else if(timeFlashOver++ > 0x001d0000)
 624   2                      {
 625   3                              CS = 1;
 626   3                              flash = 0;
 627   3                              SPIF = 1;
 628   3                              MMC_CMD = 0x00;
 629   3                              goto EndSpiIsr;
 630   3                      }
 631   2                      SPI0DAT = 0xFF;
 632   2              } 
 633   1       //-end read
 634   1              else if(MMC_CMD == 0x40) //--eof--
 635   1              {
 636   2                      CS = 0; 
 637   2                      MMC_CMD = 0x41; 
 638   2                      SPI0DAT = 0xFF;
 639   2              }
 640   1              else if(MMC_CMD == 0x41) 
 641   1              {
 642   2                      MMC_CMD = 0x42; 
 643   2                      SPI0DAT = 0x58;
 644   2              }
 645   1              else if(MMC_CMD == 0x42) 
 646   1              {
 647   2                      MMC_CMD = 0x43;
 648   2                      SPI0DAT = ((eofaddr & 0xff000000) >> 24);
 649   2              }
 650   1              else if(MMC_CMD == 0x43) 
 651   1              {
 652   2                      MMC_CMD = 0x44;
 653   2                      SPI0DAT = ((eofaddr & 0x00ff0000) >> 16);
 654   2              }
 655   1              else if(MMC_CMD == 0x44) 
 656   1              {
 657   2                      MMC_CMD = 0x45;
 658   2                      SPI0DAT = ((eofaddr & 0x0000ff00) >> 8);
 659   2              }
 660   1              else if(MMC_CMD == 0x45) 
 661   1              {
 662   2                      MMC_CMD = 0x46;
 663   2                      SPI0DAT = eofaddr & 0x000000ff;
 664   2              }
 665   1              else if(MMC_CMD == 0x46) 
 666   1              {
 667   2                      MMC_CMD = 0x47;
 668   2                      SPI0DAT = 0xFF;
 669   2              }
 670   1              else if(MMC_CMD == 0x47)
 671   1              {
 672   2                      timeFlashOver = 0;
 673   2                      MMC_CMD = 0x48;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 12  

 674   2                      SPI0DAT = 0xFF;
 675   2              }
 676   1              else if(MMC_CMD == 0x48)
 677   1              {
 678   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 40,60-Param Err
 679   2                      if(b == 0x00)
 680   2                      {
 681   3                              timeFlashOver=0;
 682   3                              MMC_CMD = 0x49;
 683   3                      }
 684   2                      else if(b == 0x20)
 685   2                      {
 686   3                              address = 0x00000e00;
 687   3                              MMC_CMD = 0xFF;
 688   3                      }
 689   2                      else if(b == 0x40 || b == 0x60)
 690   2                      {
 691   3                              timeFlashOver=0;
 692   3                              CS = 1;
 693   3                              flash = 3;
 694   3                              MMC_CMD = 0xFE;
 695   3                      }
 696   2                      else if(timeFlashOver++ > 0x0001f000)
 697   2                      {
 698   3                              timeFlashOver = 0;
 699   3                              CS = 1; 
 700   3                              flash = 0; 
 701   3                              flageofrec = 1;
 702   3                              MMC_CMD = 0x00;
 703   3                              SPIF = 1;
 704   3                              goto EndSpiIsr;
 705   3                      }
 706   2                      SPI0DAT = 0xFF;
 707   2              }
 708   1              else if(MMC_CMD == 0x49)
 709   1              {
 710   2                      b = SPI0DAT;
 711   2                      if(b == 0xFF)
 712   2                      {
 713   3                              timeFlashOver=0;
 714   3                              MMC_CMD = 0x4A;
 715   3                      }
 716   2                      else if(timeFlashOver++ > 0x0001f000)
 717   2                      {
 718   3                              CS = 1;
 719   3                              flash = 0;
 720   3                              flageofrec = 1;
 721   3                              MMC_CMD = 0x00;
 722   3                              SPIF = 1;
 723   3                              goto EndSpiIsr;
 724   3                      }
 725   2                      SPI0DAT = 0xFF;
 726   2              }
 727   1              else if(MMC_CMD == 0x4A)
 728   1              {
 729   2                      i_CMD = 0;
 730   2                      MMC_CMD = 0x4B; 
 731   2                      SPI0DAT = 0xFE;
 732   2              }
 733   1              else if(MMC_CMD == 0x4B)
 734   1              {
 735   2                      if(i_CMD >= 0x200)
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 13  

 736   2                      {
 737   3                              i_CMD = 0;      
 738   3                              MMC_CMD = 0x4C; 
 739   3                              SPIF = 0; 
 740   3                              SPI0DAT = 0xFF;
 741   3                      }
 742   2                      else
 743   2                      {
 744   3                              SPI0DAT = BufferInKZA[i_CMD++];
 745   3                      }
 746   2              }
 747   1              else if(MMC_CMD == 0x4C)
 748   1              {
 749   2                      timeFlashOver=0;
 750   2                      MMC_CMD = 0x4D; 
 751   2                      SPI0DAT = 0xFF;
 752   2              }
 753   1              else if(MMC_CMD == 0x4D)
 754   1              {
 755   2                      if(SPI0DAT == 0xFF)
 756   2                      {
 757   3                              i_CMD = 0;
 758   3                              MMC_CMD = 0x4E;
 759   3                              CS = 1;
 760   3                      }
 761   2                      else if(timeFlashOver++ > 0x0001f000)
 762   2                      {
 763   3                              flageofrec = 1;
 764   3                              CS = 1;
 765   3                              flash = 0;
 766   3                              MMC_CMD = 0x00;
 767   3                              SPIF = 1;
 768   3                              goto EndSpiIsr;
 769   3                      }
 770   2                      SPI0DAT = 0xFF;
 771   2              }
 772   1              else if(MMC_CMD == 0x4E)
 773   1              {
 774   2                      if(i_CMD++ < 255)
 775   2                      {
 776   3                              SPI0DAT = 0xFF;
 777   3                      }
 778   2                      else
 779   2                      {
 780   3                              MMC_CMD = 0x50;
 781   3                              SPI0DAT = 0xFF;
 782   3                      }
 783   2              }
 784   1              else if(MMC_CMD == 0x50)
 785   1              {
 786   2                      flash = 4; 
 787   2                      CS = 0; 
 788   2                      MMC_CMD = 0x51;
 789   2                      SPI0DAT = 0xFF;
 790   2              }
 791   1              else if(MMC_CMD == 0x51) 
 792   1              {
 793   2                      MMC_CMD = 0x52; 
 794   2                      SPI0DAT = 0x51;
 795   2              }
 796   1              else if(MMC_CMD == 0x52) 
 797   1              {
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 14  

 798   2                      MMC_CMD = 0x53; 
 799   2                      SPI0DAT = (eofaddr & 0xff000000) >> 24;
 800   2              }
 801   1              else if(MMC_CMD == 0x53) 
 802   1              {
 803   2                      MMC_CMD = 0x54; 
 804   2                      SPI0DAT = (eofaddr & 0xff0000) >> 16;
 805   2              }
 806   1              else if(MMC_CMD == 0x54) 
 807   1              {
 808   2                      MMC_CMD = 0x55; 
 809   2                      SPI0DAT = (eofaddr & 0xff00) >> 8;
 810   2              }
 811   1              else if(MMC_CMD == 0x55) 
 812   1              {
 813   2                      MMC_CMD = 0x56; 
 814   2                      SPI0DAT = (eofaddr & 0xff);
 815   2              }
 816   1              else if(MMC_CMD == 0x56) 
 817   1              {
 818   2                      timeFlashOver=0;
 819   2                      MMC_CMD = 0x57; 
 820   2                      SPI0DAT = 0xFF;
 821   2              }
 822   1              else if(MMC_CMD == 0x57) 
 823   1              {
 824   2                      b = SPI0DAT;    // 00-ok, 20-Adress Err, 60-Param Err
 825   2                      if(b == 0x00)
 826   2                      {
 827   3                              MMC_CMD = 0x58;
 828   3                              timeFlashOver=0;
 829   3                      }
 830   2                      else if(b == 0x20)
 831   2                      {
 832   3                              flageofrec = 1;
 833   3                              MMC_CMD = 0x00;
 834   3                      }
 835   2                      else if(b == 0x60)
 836   2                      {
 837   3                              MMC_CMD = 0xFE;
 838   3                      }
 839   2                      else if(timeFlashOver++ > 0x0001f000)
 840   2                      {
 841   3                              flageofrec = 1;
 842   3                              CS = 1;
 843   3                              flash = 0;
 844   3                              SPIF = 1;
 845   3                              MMC_CMD = 0x00;
 846   3                              goto EndSpiIsr;
 847   3                      }
 848   2                      SPI0DAT = 0xFF;
 849   2              }
 850   1              else if(MMC_CMD == 0x58) 
 851   1              {
 852   2                      b = SPI0DAT;    
 853   2                      if(b == 0xFF)
 854   2                      {
 855   3                              timeFlashOver = 0;
 856   3                              MMC_CMD = 0x59;
 857   3                      }
 858   2                      else if(timeFlashOver++ > 0x0001f000)
 859   2                      {
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 15  

 860   3                              CS = 1;
 861   3                              flash = 0;
 862   3                              SPIF = 1;
 863   3                              flageofrec = 1;
 864   3                              MMC_CMD = 0x00;
 865   3                              goto EndSpiIsr;
 866   3                      }
 867   2                      SPI0DAT = 0xFF;
 868   2              }
 869   1              else if(MMC_CMD == 0x59) 
 870   1              {
 871   2                      b = SPI0DAT;  // FE - DataToken, 08-Err Token Out Of Range
 872   2                      if(b != 0xFF)
 873   2                      {
 874   3                              MMC_CMD = 0x5A;
 875   3                              i_CMD = 0;
 876   3                      }
 877   2                      else if(timeFlashOver++ > 0x0001f000)
 878   2                      {
 879   3                              CS = 1;
 880   3                              flash = 0;
 881   3                              SPIF = 1;
 882   3                              flageofrec = 1;
 883   3                              MMC_CMD = 0x00;
 884   3                              goto EndSpiIsr;
 885   3                      }
 886   2                      SPI0DAT = 0xFF;
 887   2              }
 888   1              else if(MMC_CMD == 0x5A) 
 889   1              {
 890   2                      b = SPI0DAT; 
 891   2                      if(i_CMD<512)
 892   2                      {
 893   3                              BuffOutKza[i_CMD++] = b;
 894   3                              SPI0DAT = 0xFF;
 895   3                      }
 896   2                      else
 897   2                      {
 898   3                              i_CMD++;
 899   3                              SPIF = 1;
 900   3                      }
 901   2      
 902   2                      if(i_CMD>=514)
 903   2                      {
 904   3                              i_CMD = 0;
 905   3                              timeFlashOver = 0;
 906   3                              MMC_CMD = 0x5B;
 907   3                      }
 908   2                      
 909   2              }
 910   1              else if(MMC_CMD == 0x5B)
 911   1              {
 912   2                      if(SPI0DAT == 0xFF)
 913   2                      {
 914   3                              CS = 1;
 915   3                              MMC_CMD = 0x5C;
 916   3                      }
 917   2                      else if(timeFlashOver++ > 0x0001f000)
 918   2                      {
 919   3                              CS = 1;
 920   3                              flash = 0;
 921   3                              SPIF = 1;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 16  

 922   3                              flageofrec = 1;
 923   3                              MMC_CMD = 0x00;
 924   3                              goto EndSpiIsr;
 925   3                      }
 926   2                      SPI0DAT = 0xFF;
 927   2              } 
 928   1              else if(MMC_CMD == 0x5C)
 929   1              {
 930   2                      if(BuffOutKza[0]==0x65 && BuffOutKza[1]==0x6f && BuffOutKza[2] == 0x66 && BuffOutKza[3]==0x65 && BuffOut
             -Kza[4]==0x6f && BuffOutKza[5] ==0x66 && BuffOutKza[6]==0x65 && BuffOutKza[7]==0x6f && BuffOutKza[8] ==0x66)
 931   2                      {
 932   3                              flash = 1;
 933   3                              flageofrec = 0;
 934   3                              MMC_CMD = 0xFF;
 935   3                      }
 936   2                      else
 937   2                      {
 938   3                              MMC_CMD = 0x40;
 939   3                              eofaddr += 0x200;
 940   3                      }
 941   2              }
 942   1      //------------------------
 943   1              EndSpiIsr:
 944   1              SFRPAGE = SFRPAGE_SAVE;
 945   1              return;
 946   1      }
 947          
 948          //-----------------------------------------------------------------------
 949          void MMC_init1(void)
 950          {
 951   1              address = 0x00000A00;
 952   1              nzap = 0;
 953   1              szflash = 0;
 954   1              MMC_CMD = 0x00;
 955   1              SPIF = 1;
 956   1              return;
 957   1      }
 958          
 959          //-----------------------------------------------------------------------
 960          bit WriteInKZA(unsigned char byte)
 961          {
 962   1              static xdata unsigned int counterBuf = 9, endZapCount = 0;
 963   1              xdata unsigned char CRC;
 964   1              xdata unsigned long tmpNzap;
 965   1              static xdata unsigned long saveaddr, eof=0;
 966   1              
 967   1              if(MMC_CMD == 0xFF)
 968   1              {
 969   2                      flash = 1;
 970   2              }
 971   1      
 972   1              if(MMC_CMD == 0xFE)
 973   1              {
 974   2                      return 0;
 975   2              }
 976   1      
 977   1              if((flageofrec == 1)&&(flash == 1))
 978   1              {
 979   2                      flash = 0;
 980   2                      MMC_CMD = 0x40;
 981   2              }       
 982   1              if(MMC_CMD == 0x40)
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 17  

 983   1              {
 984   2                      SPIF = 1;
 985   2              }
 986   1              if((flash == 1)&&(nzap == 0)&&(szflash > 0))
 987   1              {
 988   2                      address = 0x00000c00;
 989   2                      flash = 4;
 990   2                      MMC_CMD = 0x30;
 991   2                      SPIF = 1;
 992   2              }
 993   1              else if((flash == 5)&&(nzap == 1))
 994   1              {
 995   2                      eofaddr = 0x1000;
 996   2                      address = 0xc00;
 997   2                      lastaddr = 0xe00;
 998   2                      jump = 1;
 999   2                      nzap++;
1000   2                      for(i_wr = 0; i_wr < 512; i_wr++)
1001   2                      {
1002   3                              BufferInKZA[i_wr++]=0x00;
1003   3                      }
1004   2                      BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1005   2                      BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1006   2                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1007   2                      BufferInKZA[3] =  nzap & 0x000000ff;  
1008   2                      BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1009   2                      BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1010   2                      BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1011   2                      BufferInKZA[7] =  lastaddr & 0x000000ff;  
1012   2                      CRC = BufferInKZA[0];           
1013   2                      for(i_wr = 1; i_wr < 8; i_wr++)
1014   2                      {
1015   3                                      CRC = CRC^BufferInKZA[i_wr];
1016   3                      }
1017   2                      BufferInKZA[8]  = CRC;
1018   2                      MMC_CMD = 0x10;
1019   2                      SPIF = 1;       
1020   2              }
1021   1              else if((flash == 5)&&(nzap > 1))
1022   1              {
1023   2                      tmpNzap = BuffOutKza[0];
1024   2                      for(i_wr = 1; i_wr < 4; i_wr++)
1025   2                      {
1026   3                              tmpNzap = (tmpNzap<<8)+BuffOutKza[i_wr];
1027   3                      }
1028   2                                      
1029   2                      if(nzap != tmpNzap)
1030   2                      {
1031   3                              if(BuffOutKza[0]==0x65 && BuffOutKza[1]==0x6f && BuffOutKza[2] == 0x66 && BuffOutKza[3]==0x65 && BuffOu
             -tKza[4]==0x6f && BuffOutKza[5] ==0x66 && BuffOutKza[6]==0x65 && BuffOutKza[7]==0x6f && BuffOutKza[8] ==0x66)
1032   3                              {
1033   4                                              lastaddr = address;
1034   4                                              address = 0xc00;
1035   4                                              jump = 1;
1036   4                                              nzap++;
1037   4                                              for(i_wr = 0; i_wr < 512; i_wr++)
1038   4                                              {
1039   5                                                      BufferInKZA[i_wr++]=0x00;
1040   5                                              }
1041   4                                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1042   4                                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1043   4                                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 18  

1044   4                                              BufferInKZA[3] =  nzap & 0x000000ff;  
1045   4                                              BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1046   4                                              BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1047   4                                              BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1048   4                                              BufferInKZA[7] =  lastaddr & 0x000000ff;  
1049   4                                              CRC = BufferInKZA[0];           
1050   4                                              for(i_wr = 1; i_wr < 8; i_wr++)
1051   4                                              {
1052   5                                                      CRC = CRC^BufferInKZA[i_wr];
1053   5                                              }
1054   4                                              BufferInKZA[8]  = CRC;
1055   4                                              MMC_CMD = 0x10;
1056   4                                              SPIF = 1;
1057   4                              }
1058   3                              else
1059   3                              {
1060   4                                      address += 0x200;       
1061   4                                      if(address > szflash) 
1062   4                                              address = 0x1000;
1063   4                                      
1064   4                                      eof++;
1065   4                                      if(eof>0x3e8)   
1066   4                                      {
1067   5                                              lastaddr = eofaddr;
1068   5                                              address = 0x00000c00;
1069   5                                              jump = 1;
1070   5                                              nzap++;
1071   5                                              for(i_wr = 0; i_wr < 512; i_wr++)
1072   5                                              {
1073   6                                                      BufferInKZA[i_wr++]=0x00;
1074   6                                              }
1075   5                                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1076   5                                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1077   5                                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1078   5                                              BufferInKZA[3] =  nzap & 0x000000ff;  
1079   5                                              BufferInKZA[4] = (lastaddr & 0xff000000) >> 24;
1080   5                                              BufferInKZA[5] = (lastaddr & 0x00ff0000) >> 16;
1081   5                                              BufferInKZA[6] = (lastaddr & 0x0000ff00) >> 8;
1082   5                                              BufferInKZA[7] =  lastaddr & 0x000000ff;  
1083   5                                              CRC = BufferInKZA[0];           
1084   5                                              for(i_wr = 1; i_wr < 8; i_wr++)
1085   5                                              {
1086   6                                                      CRC = CRC^BufferInKZA[i_wr];
1087   6                                              }
1088   5                                              BufferInKZA[8]  = CRC;
1089   5                                              MMC_CMD = 0x10;
1090   5                                              SPIF = 1;
1091   5                                      }
1092   4                                      else
1093   4                                      {
1094   5                                              flash = 4;
1095   5                                              MMC_CMD = 0x30;
1096   5                                              SPIF = 1;
1097   5                                      }
1098   4                              }
1099   3                      }
1100   2                      else  //читать дальше
1101   2                      {
1102   3                              CRC = BuffOutKza[0];
1103   3                              for(i_wr = 1; i_wr < 9; i_wr++)
1104   3                              {
1105   4                                      CRC = CRC^BuffOutKza[i_wr];;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 19  

1106   4                              }
1107   3                              if(!CRC) 
1108   3                              {
1109   4                                      address = BuffOutKza[4];
1110   4                                      address = (address<<8)+BuffOutKza[5];
1111   4                                      address = (address<<8)+BuffOutKza[6];
1112   4                                      address = (address<<8)+BuffOutKza[7];
1113   4                              }
1114   3                              else
1115   3                              {
1116   4                                      address += 0x200;       
1117   4                              }
1118   3                              flash = 4;
1119   3                              MMC_CMD = 0x30;
1120   3                              SPIF = 1;
1121   3                      }
1122   2              }
1123   1              else if((flash == 5)&&(nzap == 0))
1124   1              {
1125   2                      CRC = BuffOutKza[0];
1126   2                      for(i_wr = 1; i_wr < 9; i_wr++)
1127   2                      {
1128   3                              CRC = CRC^BuffOutKza[i_wr];;
1129   3                      }
1130   2                      if(!CRC && (BuffOutKza[0]!=0 || BuffOutKza[1]!=0 || BuffOutKza[2]!=0 || BuffOutKza[3]!=0 || BuffOutKza[4
             -]!=0 || BuffOutKza[5]!=0 || BuffOutKza[6]!=0 || BuffOutKza[7]!=0 || BuffOutKza[8]!=0)) 
1131   2                      {
1132   3                                      nzap = BuffOutKza[0];
1133   3                                      for(i_wr = 1; i_wr < 4; i_wr++)
1134   3                                      {
1135   4                                              nzap = (nzap<<8)+BuffOutKza[i_wr];
1136   4                                      }
1137   3                                      lastaddr = BuffOutKza[4];
1138   3                                      for(i_wr = 5; i_wr < 8; i_wr++)
1139   3                                      {
1140   4                                              lastaddr = (lastaddr<<8)+BuffOutKza[i_wr];
1141   4                                      }
1142   3                                      
1143   3                                      address = lastaddr;
1144   3                      }
1145   2                      else
1146   2                      {
1147   3                                      nzap = 1;
1148   3                                      address = 0xe00;
1149   3                                      lastaddr = address;
1150   3                      }
1151   2                      flash = 4;
1152   2                      MMC_CMD = 0x30;
1153   2                      SPIF = 1;
1154   2              }
1155   1      
1156   1              if((flash == 1)&&(counterBuf < 512))
1157   1              {
1158   2                      BufferInKZA[counterBuf++] = byte;       
1159   2                      return 1;
1160   2              }
1161   1              else if((counterBuf >= 512)&&(szflash > 0)&&(flash == 1))
1162   1              {
1163   2                      if((eofaddr-address)<0x400 || (eofaddr-address) > szflash)
1164   2                      {
1165   3                              flageofrec = 1;
1166   3                              eofaddr = address + 0x7d000;
C51 COMPILER V9.00   MMCFLASH5                                                             07/30/2012 08:39:59 PAGE 20  

1167   3                              if(eofaddr > szflash) 
1168   3                                      eofaddr = 0x1200; 
1169   3                              
1170   3                              for(i_wr = 0; i_wr < 9; i_wr++)
1171   3                              {
1172   4                                      BufferInKZA[i_wr++]=0x65;
1173   4                                      BufferInKZA[i_wr++]=0x6f;
1174   4                                      BufferInKZA[i_wr]=0x66;
1175   4                              }
1176   3                              MMC_CMD = 0x40;
1177   3                      }
1178   2                      else
1179   2                      {
1180   3                              BufferInKZA[0] = (nzap & 0xff000000) >> 24;
1181   3                              BufferInKZA[1] = (nzap & 0x00ff0000) >> 16;
1182   3                      BufferInKZA[2] = (nzap & 0x0000ff00) >> 8;
1183   3                              BufferInKZA[3] =  nzap & 0x000000ff;  
1184   3                              BufferInKZA[4] = (eofaddr & 0xff000000) >> 24;
1185   3                              BufferInKZA[5] = (eofaddr & 0x00ff0000) >> 16;
1186   3                              BufferInKZA[6] = (eofaddr & 0x0000ff00) >> 8;
1187   3                              BufferInKZA[7] =  eofaddr & 0x000000ff;  
1188   3                              CRC = BufferInKZA[0];           
1189   3                              for(i_wr = 1; i_wr < 8; i_wr++)
1190   3                              {
1191   4                                      CRC = CRC^BufferInKZA[i_wr];
1192   4                              }
1193   3                              BufferInKZA[8]  = CRC;
1194   3                              counterBuf = 9;
1195   3                              MMC_CMD = 0x10;
1196   3                              SPIF = 1;
1197   3                      }
1198   2              }
1199   1              else if((flash == 1)&&(szflash == 0))
1200   1              {
1201   2                      MMC_CMD = 0x20;
1202   2                      SPIF = 1;
1203   2              }
1204   1      
1205   1              return 0;
1206   1      }
*** WARNING C280 IN LINE 962 OF MMCFLASH5.C: 'endZapCount': unreferenced local variable
*** WARNING C280 IN LINE 965 OF MMCFLASH5.C: 'saveaddr': unreferenced local variable
1207          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6970    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   1077      12
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
